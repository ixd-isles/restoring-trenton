<html>
<head>
<title>RESTORING TRENTON - INTERACTIVE MAP</title>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

<script src="jquery/jquery-1.6.4.min.js"></script>
<script src="spin-js/spin.js"></script>
<script src="spin-js/jquery.spin.js"></script>
<script src="d3-table/d3.min.js"></script>



<link rel="stylesheet" href="GeoSearch/css/l.geosearch.css" />
    <script src="GeoSearch/js/l.control.geosearch.js"></script>
    <script src="GeoSearch/js/l.geosearch.provider.google.js"></script>

<link rel="stylesheet" href="leaflet-sidebar/L.Control.Sidebar.css" />
    <script src="leaflet-sidebar/L.Control.Sidebar.js"></script>
	<script src="button/leaflet-button.js"></script>

<button id="searchbutton" role="button" class="btn-primary"><img src="button/eye_444444_18.png"></button>
<button id="quicksearchbutton" role="button" class="btn-primary"><img src="button/search_444444_18.png"></button>
<button id="deselectbutton" role="button" class="btn-primary"><img src="button/reply_ff9900_18.png"></button>
	
</head>
<body>

<style>


.leaflet-control-layers-toggle:after{ 
    content: "LAYERS"; 
    color:#888888 ;
}
.leaflet-control-layers-toggle{ 
    width:auto;
    background-position:3px 50% ;
	padding-right:8px;
    padding-left:36px;
    text-decoration:none;
    line-height:36px;
} 

#sidebar{
	font-family:"Courier New";
	padding:10px;
}

#option{
	font-family:"Courier New";
}

.btn-primary{
	background: none repeat scroll 0 0 rgba(0, 0, 0, 0.25);
	background-color:#ffffff;
	font-family:"Courier New";
	font-size:12px;
	color:#777777;
	border-radius: 4px;
	margin: 0 0 0 10px;
	padding: 3px;
	height: auto;
}

table, td {
	border-collapse: collapse;
	border: 1px solid #777777;
	font-family: "Courier New";
	font-size:12px;
}

td {
    padding: 8px;
}

#spinBox {
    z-index:999;
    opacity:0.5;
    display:none;
    border-radius:0.25em;
    width:5em;
    height:5em;
    margin: -2.5em 0 0 -2.5em;
    background-color:#f0f3f6;
    border:1px solid #fff;
    position:fixed;
    top:50%;
    left:50%
}

#queryTable {
	font-family:"Courier New";
	font-size:12px;
}

a {
color:#ff9900;
}

</style>


<div id = "queryTable" style="margin: 20px auto; width: 100%; display:none"></div>

<div id="map" style="width: 100%; height: 100%;"></div>
<div id="spinBox" class='spinner'></div>

<script type="text/javascript">

var config =
{
	city: "Trenton",
	southwest: L.latLng(40.18000, -74.85000),
    northeast: L.latLng(40.26000, -74.67000),
    rev_geocoding_apikey: 'AIzaSyAKf5AB_5QngOuThxqDCo8A8U17qpCBu00',
    database_name: 'trenton_master',
    additional_attrib : 'created by iana dikidjieva for <a href="http://www.restoringtrenton.org">restoring trenton</a>.<br>',
   	sql_url : 'http://restoringtrenton.cartodb.com/api/v2/sql?q=',
	sidebar_content : "<fieldset><b>ADVANCED SEARCH</b><br>" +
	"Instructions on constructing your queries can be found here." + 
	"<table style='border:none'><tr><td style='border:none'>" +
		"<p style='float:left; padding-left:7px; padding-right:7px;'><a id='btnQuery' class='btnQuery' href='javascript:mapSelection();'><img src='button/map_000000_32.png'></a><br>MAP</p>" +
		"<p style='float:left; padding-left:7px; padding-right:7px; '><a id='btnTable' class='btnTable' href='javascript:makeTable();'><img src='button/table_444444_32.png'></a><br>TABLE</p>" +
		"<p style='float:left; padding-left:7px; padding-right:7px'><a id='btnDownload' class='btnDownload' href='javascript:downloadSelection();'><img src='button/download_000000_32.png'></a><br>SAVE</p>" +
		"<p style='float:left; padding-left:7px; padding-right:7px'><a id='btnClear' class='btnClear' href='javascript:clearSelection();'><img src='button/reply_000000_32.png'></a><br>CLEAR</p>" +		
	"</tr></td></table>" +
	"<hr>" +
	"<form id='advanced_search'>"+
	"<b>ADDRESS</b><br>" + "<input type='text' id = 'SR_address' value = ''>" + "<br>"  +
    "<b>OWNER</b><br> <input type = 'text' id='SR_owner' value = ''>" + "<br>" +
    "<b>PARCEL TYPE</b><br>" +
		"<select id='SR_parc_type' name='SR_parc_type'>" + "<br>" +
  			"<option value='ANY' selected='selected'>ANY</option>" +
  			"<option value='VACANT BLDG'>VACANT BLDG</option>" +
  			"<option value='VACANT LOT'>VACANT LOT</option>" +
		"</select> " + 
		"<br><br>" +
		"<div class='checkbox'><label><input type = 'checkbox' id='SR_class'><b>PROPERTY CLASS 2</B><br>(1-4 FAMILY RESIDENTIAL)</option></label></div>" +
		"<br>" +
		"<b>CONDITIONS</b><br>"+
		"Selecting more conditions will find properties with ANY of these conditions ('OR' search):" +
		"<div class='checkbox'><label><input type = 'checkbox' id='dumping'>DUMPING</option></label></div>" +
	    "<div class='checkbox'><label><input type = 'checkbox' id='trash'>TRASH</option></label></div>" + 
	    "<div class='checkbox'><label><input type = 'checkbox' id='xs'>Xs</option></label></div>" +
	    "<div class='checkbox'><label><input type = 'checkbox' id='dilapidated'>DILAPIDATED</option></label></div>" +
	    "<div class='checkbox'><label><input type = 'checkbox' id='unsecured'>UNSECURED</option></label></div>" +
	    "<div class='checkbox'><label><input type = 'checkbox' id='animals'>ANIMALS</option></label></div>" + 
		"<div class='checkbox'><label><input type = 'checkbox' id='unmaintained'>UNMAINTAINED</option></label></div>" +
	    "<div class='checkbox'><label><input type = 'checkbox' id='weeds'>WEEDS</option></label></div>" +
		"<br><b>ZONING</b> <select id='SR_zoning' name='SR_zoning'>" + "<br>" +
  			"<option value='ANY' selected='selected'>ANY</option>" +
  			"<option value='RESIDENCE'>RESIDENTIAL</option>" +
  			"<option value='BUSINESS'>COMMERCIAL</option>" +
			"<option value='INDUSTRIAL'>INDUSTRIAL</option>" +
			"<option value='MIXED USE'>MIXED USE</option>" +
		"</select> " + "<br>" +
	    "</form></fieldset>",
		
		table_base : "<h3>SEARCH RESULTS</h3>" + 
			"<button role='button' class='btn-primary' onclick='javascript:hideTable();'><img src='button/map_444444_16.png'></button> back to map "+
			"<button role='button' class='btn-primary' onclick='javascript:downloadSelection();'><img src='button/download_444444_16.png'></button> save as .csv " +
			"<hr>"
	  
}	

var sql = new cartodb.SQL({ user: 'restoringtrenton', format: 'geojson' });
var polygon;
var searchPolygons = [];
var searchResults = [];
var searchModule;
var quickSearchOn = 0;
var sidebar;
var cartoURL = '';
var query_string='';
var queryHighlightOn = 0;
var deselectButton = new L.Control.Button(L.DomUtil.get('deselectbutton'), { toggleButton: 'active' });


var popup = L.popup();

var map = L.map('map').setView([40.224, -74.76], 15);
var stamen = L.tileLayer('http://a.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {attribution: config.additional_attrib + ' uses a <a href="http://stamen.com">stamen</a> basemap'});
stamen.addTo(map);

googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
    maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3'],
	attribution: config.additional_attrib + ' uses google satellite'
});

 
var bases = { "streets (stamen toner lite)": stamen, "google satellite": googleSat};

<!-- BE SURE THIS IS THE LATEST UPDATE OF THE MASTER PARCEL FILE!!! -->
var parcelMasterURL = 'https://restoringtrenton.cartodb.com/api/v2/viz/aebbd47a-5690-11e5-beed-0e853d047bba/viz.json';

<!-- reference auxiliary data -->

<!-- colors on redev areas layer are styled in cartodb bc i am lazy -->
var redev_areasURL = 'https://restoringtrenton.cartodb.com/api/v2/viz/c0afc7fc-5692-11e5-ac65-0e0c41326911/viz.json';

var infoLayer = new L.geoJson();
var formURL = '';

var spinner = new Spinner().spin(spinBox);
$('#spinBox').show();

		$.getJSON(
            "https://restoringtrenton.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM trenton_master LIMIT 40000",
            function(data) {
			
	        infoLayer = L.geoJson(data, {
				style: 	{color: "#ffffff", fillColor:"#ffffff", weight: 0, opacity:0, fillOpacity:0},
				
				onEachFeature: function (feature, layer) {
				var bounds = layer.getBounds();
				var center = bounds.getCenter();

				//sigh, we resort to creepy google again to make the form to report the issues. 
				
				var propAdd = feature.properties.address;
				var cartodbID = feature.properties.cartodb_id;
				var formURL="https://docs.google.com/forms/d/11QPK0sF29VREQR3ke-Td3EUd1LoCh9UbHR8um8xSOrY/viewform?entry.1233008467="+propAdd+"&entry.492807532="+cartodbID+"&entry.935525454="+center+"&entry.1771840456&entry.1915372513&entry.2060863861&entry.1480924992&entry.1569579456";
				
				//but check out our sexy popup 
				
				var popupContent = "<b>"+ feature.properties.address + 
									"</b><br>"+ feature.properties.parc_type +
									"<hr><b><a href='"+ formURL + "'>REPORT AN ISSUE</a></b>" +
									"<hr><b>OWNER</B><BR>"+feature.properties.owner +
									"<br>"+feature.properties.ownstreet + 
									"<br>"+feature.properties.owncity +
									"<br><br><B>CONDITIONS</B>: " + feature.properties.conditions + 
									"<br><B>FIELD NOTES</B>: " + feature.properties.notes + 
									"<hr><B>TAX INFO</B><BR>LEADLOT: " + feature.properties.leadlot +
									"<BR>TAXES: $" + feature.properties.taxes +									
									"<br>ASSESSED: $"+feature.properties.totalassmt +
									"<br>LIENS (CITY): $" + feature.properties.city_liens + 
									"<br>LIENS (PRIVATE): $" + feature.properties.priv_liens + 
									"<hr><b>LAND USE INFO</B><BR>REDEV'T AREA: " + feature.properties.redev_area + 
									"<br>ZONING: "+feature.properties.zone_abrv+"&nbsp"+feature.properties.descriptio + 
									"<hr><b>ACTIONS</B><BR>TAX FORECLOSURE: " + feature.properties.foreclosed + 
									"<br>CITY AUCTION: " + feature.properties.auction;
				layer.bindPopup(popupContent);
				}
			});
				$('#spinBox').hide();
				infoLayer.addTo(map);
				
		});

<!-- array to hold the different overlay layers we're creating from different queries of the property database -->
  overlayLayers = {}; 
		<!-- don't forget to add any new layers to the menu! -->
  var sublayers = [allPropsGet, vacantPropsGet, lienPropsGet, cityOwnedVacGet, redevAreaGet];



<!-- basic parcel outlines - for some reason the layer selector breaks if this isn't loaded early. one day i'll learn why. -->
  
  cartodb.createLayer(map, parcelMasterURL)
    .addTo(map)
    .on('done', function(layer) { 
      layer.setZIndex(1);
      var sublayer = layer.getSubLayer(0);
      sublayer.set(allPropsGet);
      sublayers.push(sublayer);
      overlayLayers["BASE PARCELS"] = layer;

      layer.setInteraction(true);
	  

     }).on('error', function() { 
      //log the error
    });

 	
  var allPropsGet = {
    sql: "SELECT * FROM trenton_master",
    cartocss: "#trenton_properties{polygon-fill: #fff; polygon-opacity:0;line-color:#999; line-opacity:0.2;} #trenton_properties[parc_type='OPEN SPACE OR CEMETERY'] {polygon-fill:#259073; polygon-opacity:.3;}",
  }
  
  var vacantPropsGet = {
    sql: "SELECT * FROM trenton_master where parc_type like '%VACANT%'",
    cartocss: "#trenton_master[parc_type='VACANT LOT']{polygon-fill: #B9D132; polygon-opacity:0.5;line-color:#fff; line-opacity:0.4;} #trenton_master[parc_type = 'VACANT BLDG'] {polygon-fill: #FF0000; polygon-opacity:0.5;line-color: #fff; line-opacity:0.4;} #trenton_master[parc_type = 'VACANT LOWER'] {polygon-fill: #FF9900; polygon-opacity:0.6;line-color: #fff; line-opacity:0.4;}",
	  }

 

  var lienPropsGet = {
    sql: "SELECT * FROM trenton_master where (city_liens > 0 or priv_liens > 0)",
    cartocss: "#trenton_properties{polygon-fill: #000; polygon-opacity:0.2;line-color:#00FFFF ; line-width: 2; line-opacity:07;}"
  }
  
    var cityOwnedVacGet = {
    sql: "SELECT * FROM trenton_master where (owner like '%CITY OF TRENTON%' and parc_type like '%VACANT%')",
    cartocss: "#trenton_properties{polygon-opacity:0;line-color:#FFFF00; line-width: 2; line-opacity:0.6;}"
  }

 var redevAreaGet = {
	 sql: "SELECT * FROM redev_areas"}
  
<!-- var homesteadGet = {
 //   sql: "SELECT * FROM trenton_master where owner = 'CITY OF TRENTON' and class = '2' and parc_type = 'VACANT BLDG' and redev_area is not NULL",
 //   cartocss: "#trenton_properties{polygon-fill: #00FBFF; polygon-opacity:0.2;line-color:#00FBFF ; line-width: 3; line-opacity:0.8;}"
 // }

 
  var auctionsGet = {
	 sql: "SELECT * FROM auctionURL",
	 cartocss: "#auctions{polygon-fill:...; ...}"
 }
 
 
-->

<!-- here are the vacants -->  
  cartodb.createLayer(map, parcelMasterURL)
    .addTo(map)
    .on('done', function(layer) { 
      layer.setZIndex(2);
      var sublayer = layer.getSubLayer(0);
	  sublayer.set(vacantPropsGet);
      sublayers.push(sublayer);
      overlayLayers["VACANT PROPERTIES"] = layer;

      layer.setInteraction(false);
	  
     }).on('error', function() { 
      //log the error
    });

	
<!-- taking out the homestead layer since we don't KNOW YET, argh	-->
//  cartodb.createLayer(map, parcelMasterURL)
//    .addTo(map)
//    .on('done', function(layer) { 
//      layer.setZIndex(4);
//      var sublayer = layer.getSubLayer(0);
//      sublayer.set(homesteadGet);
//      sublayers.push(sublayer);
//      overlayLayers["POSSIBLE HOMESTEADS"] = layer;
//        layer.setInteraction(false);
	  
//     }).on('error', function() { 
      //log the error
//    });


<!-- enable the auction layer when there's an upcoming auction -->	
/*  cartodb.createLayer(map, parcelMasterURL)
    .addTo(map)
    .on('done', function(layer) { 
      layer.setZIndex(5);
      var sublayer = layer.getSubLayer(0);
      sublayer.set(auctionGet);
      sublayers.push(sublayer);
      overlayLayers["AUCTIONS"] = layer;
      layer.setInteraction(false);
	  
     }).on('error', function() { 
      //log the error
    });
*/

<!-- city-owned vacants -->
 cartodb.createLayer(map, parcelMasterURL)
    .on('done', function(layer) { 
      layer.setZIndex(10);
      var sublayer = layer.getSubLayer(0);
      sublayer.set(cityOwnedVacGet);
      sublayers.push(sublayer);
      overlayLayers["CITY-OWNED VACANTS"] = layer;
      layer.setInteraction(false);

     }).on('error', function() { 
      //log the error
    });	


	
<!-- liens, whoo -->
  cartodb.createLayer(map, parcelMasterURL)
    .on('done', function(layer) { 
      layer.setZIndex(5);
      var sublayer = layer.getSubLayer(0);
      sublayer.set(lienPropsGet);
      sublayers.push(sublayer);
      overlayLayers["TAX LIENS"] = layer;
	        layer.setInteraction(false);
	  	  
     }).on('error', function() { 
      //log the error
    });

<!-- redevelopment areas -->
cartodb.createLayer(map, redev_areasURL)
    .on('done', function(layer) { 
      layer.setZIndex(15);
      var sublayer = layer.getSubLayer(0);

      sublayer.set(redevAreaGet);
      sublayers.push(sublayer);
	  layer.setInteraction(false);
      overlayLayers["REDEVELOPMENT AREAS"] = layer;
	  
	  <!-- YOU HAVE TO PUT THE LAYER SELECTOR IN THE LAST LAYER. DON'T $@^! ASK. -->
	  L.control.layers(bases, overlayLayers, {position:'topright'}).addTo(map);
	  

     }).on('error', function() { 
      //log the error
    });
	
 
 <!-- data query sidebar -->
 
  var div_sidebar = document.createElement('div');
  div_sidebar.id = "sidebar";
  $('body')[0].appendChild(div_sidebar);
  
  sidebar = L.control.sidebar('sidebar', {
      position: 'left'
  });
	map.addControl(sidebar);
	sidebar.setContent(config.sidebar_content);
  
  	searchButton = new L.Control.Button(L.DomUtil.get('searchbutton'), { toggleButton: 'active' });
	searchButton.addTo(map);
	searchButton.on('click', function () {
		sidebar.toggle()
	});
	
 <!-- stupid Google search addresses (THIS DOES NOT QUERY THE ACTUAL dB) -->
	searchModule = new L.Control.GeoSearch({
				provider: new L.GeoSearch.Provider.Google(), showMarker: false,
			})
	quicksearchButton = new L.Control.Button(L.DomUtil.get('quicksearchbutton'), { toggleButton: 'active' });
	quicksearchButton.addTo(map);
	quicksearchButton.on('click', function () {
		if (quickSearchOn != 0) {
			searchModule.removeFrom(map);
			quickSearchOn = 0;
			console.log('quick search is now off');
		}
		else {
			searchModule.addTo(map); 
			quickSearchOn = 1;
				console.log('quick search is now on');
		}

	});	
  

 
//searchie searchie!
  

		var parcelPolygon = new L.geoJson();
  
  	function runQuery(){

		map.removeLayer(parcelPolygon);
		cartoURL = 'https://restoringtrenton.cartodb.com/api/v2/sql?format=GeoJSON&q=';
		query_string = "SELECT address, parc_type, owner, ownstreet, owncity, conditions, notes, waiv_type, leadlot, class, taxes, bldgassmt, totalassmt, lastsold, saleprice, city_liens, priv_liens, zone_abrv, descriptio, redev_area, histdist, foreclosed, auction, cartodb_id, the_geom from trenton_master";
		var input_parc_type = $('#SR_parc_type').val();
		var input_zoning = $('#SR_zoning').val();
		var input_owner = $('#SR_owner').val();
	    var input_address = $('#SR_address').val();
		var input_count = 0;
		var whereClause = "";
		var selections = [];
		var optionClause = '';
		var checkedOptions = [];
		var option_count = 0;
	
		
		if (input_parc_type == 'ANY'){
			whereClause = " WHERE ";
			input_parc_type = "parc_type is not null";
			input_count = input_count+1;
			selections[input_count] = input_parc_type;
			console.log (whereClause, input_parc_type, input_count, selections[input_count]);
		}
		else{
			whereClause = " WHERE ";
			input_parc_type = "parc_type = '" + input_parc_type + "'";
			input_count = input_count+1;
			selections[input_count] = input_parc_type;
			console.log (whereClause, input_parc_type, input_count, selections[input_count]);
		}
		
		if (input_zoning != 'ANY'){
			input_zoning = "descriptio = '" + input_zoning + "'";
			input_count = input_count+1;
			selections[input_count] = input_zoning;
			console.log (whereClause, input_zoning, input_count, selections[input_count]);
			}
		
		if (input_owner != "") {
			whereClause = " WHERE ";
			input_owner = input_owner.toUpperCase();
			input_owner = "owner ilike '%"+ input_owner + "%'";
			input_count = input_count+1;
			selections[input_count] = input_owner;
			console.log (whereClause, input_owner, input_count, selections[input_count]);
		}
		
		if (input_address != "") {
			//add scrubber for North, South, etc. and street type
			whereClause = " WHERE ";
			input_address = input_address.toUpperCase();
			input_address = "address ilike '%" + input_address + "%'";
			input_count = input_count+1;
			selections[input_count] = input_address;
			console.log (whereClause, input_address, input_count, selections[input_count]);
		}
		
		if (document.getElementById("SR_class").checked) {
			whereClause = " WHERE ";
			input_count = input_count+1;
			selections[input_count] = "class = '2'";
		}
		
		if ((document.getElementById("dumping").checked) || (document.getElementById("trash").checked) || (document.getElementById("xs").checked) || (document.getElementById("dilapidated").checked) || (document.getElementById("unsecured").checked) || (document.getElementById("animals").checked) || (document.getElementById("unmaintained").checked) || (document.getElementById("weeds").checked)) {
			whereClause = " WHERE ";
			//add dropdown AND/OR operator!
			input_count = input_count+1;
			
			if (document.getElementById("dumping").checked) {
			checkedOptions[option_count] = "DUMPING";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("trash").checked) {
			checkedOptions[option_count] = "TRASH";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("xs").checked) {
			checkedOptions[option_count] = "XS";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("dilapidated").checked) {
			checkedOptions[option_count] = "DILAPIDATED";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("unsecured").checked) {
			checkedOptions[option_count] = "UNSECURED";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("animals").checked) {
			checkedOptions[option_count] = "ANIMALS";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("unmaintained").checked) {
			checkedOptions[option_count] = "UNMAINTAINED";
			option_count = option_count + 1;
			}
			
			if (document.getElementById("weeds").checked) {
			checkedOptions[option_count] = "WEEDS";
			option_count = option_count + 1;
			}
			
			if (option_count > 0) {
			optionClause = "CONDITIONS ilike '%" + checkedOptions[0] + "%'";
			for (i=1; i<option_count; i++) {
				optionClause = optionClause + " OR CONDITIONS ilike '%" + checkedOptions[i] + "%'";
			}
			}
				
			selections[input_count] = optionClause;
			console.log (whereClause, optionClause, input_count, selections[input_count]);
		}
		
		query_string = query_string + whereClause + selections[1];
		console.log(query_string);
		
		if (input_count > 1) {
		for (i=2; i <= input_count; i++) {
		query_string = query_string + " AND " + selections[i];
		}
		
		}
				cartoURL = cartoURL + encodeURI(query_string);
                console.log('calling url = '+ cartoURL);

	  }

	function mapSelection()
	{
		hideTable();
		var spinner = new Spinner().spin(spinBox);
		$('#spinBox').show();
	
		runQuery();
		

			$.getJSON(cartoURL, function(data) {
				parcelPolygon = L.geoJson(data, {
					onEachFeature: function (feature, layer) {
				 
					var popupContent = "<b>"+ feature.properties.address + "</b><br>"+ feature.properties.parc_type+"<hr><b>OWNER</B><BR>"+feature.properties.owner+"<br>"+feature.properties.ownstreet+"<br>"+feature.properties.owncity+"<br><br><B>CONDITIONS</B>: "+feature.properties.conditions+"<br><B>FIELD NOTES</B>: "+feature.properties.notes+"<hr><B>TAX INFO</B><BR>TAXES: $"+feature.properties.taxes+"<br>ASSESSED: $"+feature.properties.totalassmt +"<br>LIENS (CITY): $"+feature.properties.city_liens+"<br>LIENS (PRIVATE): $"+feature.properties.priv_liens+"<hr><b>LAND USE INFO</B><BR>REDEV'T AREA: "+feature.properties.redev_area+"<br>ZONING: "+feature.properties.zone_abrv+"&nbsp"+feature.properties.descriptio+"<hr><b>ACTIONS</B><BR>TAX FORECLOSURE: "+feature.properties.foreclosed + "<br>CITY AUCTION: "+feature.properties.auction;
					layer.bindPopup(popupContent);
					}
				});
				map.fitBounds(parcelPolygon.getBounds());
				parcelPolygon.addTo(map);
				$('#spinBox').hide();
	 
			});
			queryHighlightOn=1;
			deselectButton.addTo(map);
			deselectButton.on('click', function () {
				clearSelection();
			});
	}
    	
	
	
	function clearSelection()
	{
		hideTable();
		query_string = '';
		cartoURL = '';
		map.removeLayer(parcelPolygon);
		advanced_search.reset();
		queryHighlightOn=0;
		deselectButton.removeFrom(map);
		map.setView([40.224, -74.76], 15);
		
     }

	function downloadSelection()
	{
		runQuery();
		cartoURL = 'https://restoringtrenton.cartodb.com/api/v2/sql?format=CSV&filename=restoring_trenton_query.csv&q=';
		cartoURL = cartoURL + encodeURI(query_string);
		window.open(cartoURL);
     
		}
		
	function makeTable()
	{
		runQuery();
		cartoURL = 'https://restoringtrenton.cartodb.com/api/v2/sql?format=CSV&filename=restoring_trenton_query.csv&q=';
		cartoURL = cartoURL + encodeURI(query_string);

		document.getElementById('queryTable').innerHTML = config.table_base;
		var spinner = new Spinner().spin(spinBox);
		$('#spinBox').show();
		
		d3.text(cartoURL, function(data) {
                var parsedCSV = d3.csv.parseRows(data);

                var container = d3.select("#queryTable")
                    .append("table")

                    .selectAll("tr")
                        .data(parsedCSV).enter()
                        .append("tr")

                    .selectAll("td")
                        .data(function(d) { return d; }).enter()
                        .append("td")
                        .text(function(d) { return d; });
				
				$('#spinBox').hide();
            	
			});
		document.getElementById('map').style.display = 'none';	
		document.getElementById('queryTable').style.display = 'block';

	}
	function hideTable()
	{
		document.getElementById('queryTable').style.display = 'none';
		document.getElementById('map').style.display = 'block';
	}

     
		


	
  
  
</script>
</body>
</html>
